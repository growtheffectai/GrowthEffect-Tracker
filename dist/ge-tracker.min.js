!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GETracker={})}(this,function(t){"use strict";function e(t,e,r,o){return new(r||(r=Promise))(function(i,n){function a(t){try{c(o.next(t))}catch(t){n(t)}}function s(t){try{c(o.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(a,s)}c((o=o.apply(t,e||[])).next())})}function r(){const t=function(){const t={};try{const e=new URLSearchParams(window.location.search);["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(r=>{const o=e.get(r);o&&(t[r]=o)})}catch(t){console.error("[GECapture] Error extracting UTM params:",t)}return t}();return Object.keys(t).length>0?(function(t){try{Object.keys(t).length>0&&localStorage.setItem("ge_utm_params",JSON.stringify(t))}catch(t){console.error("[GECapture] Error storing UTM params:",t)}}(t),t):function(){try{const t=localStorage.getItem("ge_utm_params");if(t)return JSON.parse(t)}catch(t){console.error("[GECapture] Error retrieving stored UTM params:",t)}return{}}()}"function"==typeof SuppressedError&&SuppressedError;const o={fbclid:"facebook",gclid:"google",msclkid:"microsoft",ttclid:"tiktok",li_fat_id:"linkedin",twclid:"twitter",ScCid:"snapchat",gbraid:"google",wbraid:"google"};function i(){const t=function(){try{const t=new URLSearchParams(window.location.search);for(const[e,r]of Object.entries(o)){const o=t.get(e);if(o)return{clickId:o,platform:r}}}catch(t){console.error("[GECapture] Error extracting click ID:",t)}return null}();return t?(function(t){try{localStorage.setItem("ge_click_id",JSON.stringify(t))}catch(t){console.error("[GECapture] Error storing click ID:",t)}}(t),t):function(){try{const t=localStorage.getItem("ge_click_id");if(t)return JSON.parse(t)}catch(t){console.error("[GECapture] Error retrieving stored click ID:",t)}return null}()}function n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function a(){try{let t=sessionStorage.getItem("ge_session_id");return t||(t=n(),sessionStorage.setItem("ge_session_id",t)),t}catch(t){return console.error("[GECapture] Error managing session ID:",t),n()}}function s(){try{return sessionStorage.getItem("ge_landing_page")||window.location.href}catch(t){return window.location.href}}function c(){try{return document.referrer||""}catch(t){return""}}function u(){try{return navigator.userAgent||""}catch(t){return""}}class l{constructor(t){this.initialized=!1,this.formListenersAttached=!1,this.config={apiKey:t.apiKey,companyId:t.companyId||"",apiHost:t.apiHost||"http://localhost:3000",debug:t.debug||!1},this.log("GETracker initialized with config:",this.config)}init(){this.initialized?this.log("Already initialized"):(!function(){try{sessionStorage.getItem("ge_landing_page")||sessionStorage.setItem("ge_landing_page",window.location.href)}catch(t){console.error("[GECapture] Error storing landing page:",t)}}(),this.initialized=!0,this.log("GETracker SDK initialized successfully"))}autoCapture(){if(!this.initialized)throw new Error("[GETracker] Must call init() before autoCapture()");this.formListenersAttached?this.log("Auto-capture already enabled"):(this.attachFormListeners(),this.formListenersAttached=!0,this.log("Auto-capture enabled"))}attachFormListeners(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.attachToForms()):this.attachToForms(),this.observeDynamicForms()}attachToForms(){const t=document.querySelectorAll("form");this.log(`Found ${t.length} forms on the page`),t.forEach((t,r)=>{t.hasAttribute("data-ge-capture")||(t.setAttribute("data-ge-capture","true"),t.addEventListener("submit",o=>e(this,void 0,void 0,function*(){this.log(`Form ${r} submitted`);try{const e=this.extractFormData(t);if(e&&e.leadData.email){o.preventDefault(),this.log("Capturing lead data before form submission...");const r=yield this.capture(e.leadData,e.rawFormFields);r.success?(this.log("Lead captured successfully, allowing form to submit"),t.action&&t.action!==window.location.href&&t.submit()):(this.log("Lead capture failed:",r.error),t.action&&t.action!==window.location.href&&t.submit())}else this.log("Form does not contain email field, skipping capture")}catch(t){this.log("Error processing form:",t)}})))})}observeDynamicForms(){new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){const e=t;if("FORM"===e.tagName&&this.attachToForms(),e.querySelectorAll){e.querySelectorAll("form").length>0&&this.attachToForms()}}})})}).observe(document.body,{childList:!0,subtree:!0})}extractFormData(t){const e=new FormData(t),r={email:"",custom:{}},o={};e.forEach((t,e)=>{o[e]=t});const i={email:["email","e-mail","emailaddress","email_address","user_email","mail"],name:["name","fullname","full_name","username","user_name","firstname","first_name"],phone:["phone","telephone","mobile","phonenumber","phone_number","tel"],company:["company","organization","business","companyname","company_name"]};for(const[t,o]of Object.entries(i))for(const i of o){const o=e.get(i);if(o&&"string"==typeof o){r[t]=o;break}}return e.forEach((t,e)=>{const o=e.toLowerCase();Object.values(i).some(t=>t.some(t=>t===o))||"string"!=typeof t||(r.custom[e]=t)}),r.email?{leadData:r,rawFormFields:o}:null}buildAttributionData(){const t=r(),e=i();return{utmSource:t.utm_source,utmMedium:t.utm_medium,utmCampaign:t.utm_campaign,utmTerm:t.utm_term,utmContent:t.utm_content,clickId:null==e?void 0:e.clickId,adPlatform:null==e?void 0:e.platform,referrer:c(),landingPage:s(),userAgent:u(),sessionId:a()}}capture(t,o){return e(this,void 0,void 0,function*(){if(!this.initialized)throw new Error("[GETracker] Must call init() before capture()");if(!t.email)throw new Error("[GETracker] Email is required for lead tracking");const e=this.buildAttributionData(),i=r(),n=Object.assign(Object.assign({},t),{attribution:e,rawData:{formFields:o||{},utm:i,attribution:e,timestamp:(new Date).toISOString(),url:window.location.href}});this.log("Tracking lead:",n);try{const t=yield fetch(`${this.config.apiHost}/api/v1/tracker`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(n)}),e=yield t.json();return t.ok?(this.log("Tracking successful:",e),{success:!0,data:e}):(this.log("Tracking failed:",e),{success:!1,error:e.error||e.message||"Tracking failed"})}catch(t){return this.log("Network error during tracking:",t),{success:!1,error:t instanceof Error?t.message:"Network error"}}})}getUTMParams(){return r()}getSessionId(){return a()}isReady(){return this.initialized}log(...t){this.config.debug&&console.log("[GETracker]",...t)}}let d=null;function m(t){const e="string"==typeof t?{apiKey:t}:t;if(!e.apiKey)throw new Error("[GETracker] API key is required");return d=new l(e),d.init(),d}function g(){if(!d)throw new Error("[GETracker] Must call init() before autoCapture()");d.autoCapture()}function f(t){if(!d)throw new Error("[GETracker] Must call init() before capture()");return d.capture(t)}function h(){return d}"undefined"!=typeof window&&(window.GETracker={init:m,autoCapture:g,capture:f,getInstance:h,getUTMParams:()=>(null==d?void 0:d.getUTMParams())||r(),getSessionId:()=>(null==d?void 0:d.getSessionId())||a(),isReady:()=>(null==d?void 0:d.isReady())||!1}),t.autoCapture=g,t.capture=f,t.getClickId=i,t.getInstance=h,t.getSessionId=a,t.getUTMParams=r,t.init=m,t.isReady=function(){return(null==d?void 0:d.isReady())||!1}});
//# sourceMappingURL=ge-tracker.min.js.map
